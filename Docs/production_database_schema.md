# Production Database Schema Documentation

This document details the production database schema as defined by our migration files in the supabase/migrations directory. It outlines the tables, views, constraints, and security policies that govern our production data. The schema is divided into two main sections:

1. **Remote Schema Tables** – These tables manage connections and resources for our projects.
2. **Ticketing & Event Schema** – This set of tables supports our ticketing, launch weeks, and meetup events.

---

## 1. Remote Schema Tables

These tables are defined in migration files such as `20240722100743_remote_schema.sql`.

### active_pgbouncer_projects

- **Purpose:** Tracks active projects for connection pooling (pgbouncer).

#### Columns:
- **id**: bigint
  - Automatically generated as an identity column (Primary Key).
- **project_ref**: text
  - A reference for the project (nullable).

#### Security & Indexes:
- **Row Level Security (RLS):** Enabled.
- A unique index and primary key constraint on the `id` column.
- **Grants:** Permissions (delete, insert, references, select, trigger, truncate, update) are granted to roles such as `anon`, `authenticated`, and `service_role`.

---

### vercel_project_connections_without_supavisor

- **Purpose:** Manages connections for Vercel projects that do not use Supavisor.

#### Columns:
- **id**: bigint
  - Automatically generated as an identity column (Primary Key).
- **project_ref**: text (NOT NULL)
  - A reference for the project.

#### Security & Indexes:
- **Row Level Security (RLS):** Enabled.
- A unique index and primary key constraint on the `id` column.
- **Grants:** Similar permission grants as for the active_pgbouncer_projects table.

---

## 2. Ticketing & Event Schema

Defined in migrations such as `20240723155310_add_lw12_ticketing_schema.sql`, this schema supports our event ticketing system.

### launch_weeks

- **Purpose:** Represents distinct launch periods (e.g., 'lw12', 'lw13').

#### Columns:
- **id**: text
  - Primary Key, representing the launch week identifier.
- **created_at**: timestamp with time zone
  - Automatically set to the current UTC time upon record creation.
- **start_date**: timestamp with time zone (nullable)
  - The starting date/time of the launch week.
- **end_date**: timestamp with time zone (nullable)
  - The ending date/time of the launch week.

#### Policies:
- A policy ("Allow public read access") permits unrestricted SELECT operations.
- An initial record (e.g., with id 'lw12') may be inserted as part of the migration.

---

### tickets

- **Purpose:** Stores ticket information for users participating in our launch events.

#### Columns:
- **id**: uuid
  - Primary Key, generated by default using `uuid_generate_v4()`.
- **created_at**: timestamp with time zone
  - Set to the current UTC time at record creation.
- **launch_week**: text
  - Foreign key referencing `launch_weeks(id)`.
- **user_id**: uuid
  - Foreign key referencing `auth.users(id)`, linking the ticket to a user.
- **email**: text (nullable)
- **name**: text (nullable)
- **username**: text (nullable)
- **referred_by**: text (nullable)
- **shared_on_twitter**: timestamp with time zone (nullable)
- **shared_on_linkedin**: timestamp with time zone (nullable)
- **game_won_at**: timestamp with time zone (nullable)
- **ticket_number**: bigint
  - Auto-generated as an identity, unique per launch week.
- **metadata**: jsonb (nullable)
- **role**: text (nullable)
- **company**: text (nullable)
- **location**: text (nullable)

#### Constraints & Policies:
- **Unique Constraints:**
  - (email, launch_week)
  - (ticket_number, launch_week)
  - (username, launch_week)
- **Row Level Security (RLS):** Enabled.
- **Policies:**
  - *Allow user to select own ticket:* Authenticated users can read their own ticket (condition: user_id = auth.uid()).
  - *Allow authenticated user to update its own ticket:* Users can update their ticket if user_id matches auth.uid().
  - *Allow insert for authenticated users only:* Only authenticated users can insert tickets with user_id matching auth.uid().
- **Publications:** Added to `supabase_realtime` for real-time updates.

---

### tickets_view

- **Purpose:** Provides a public view of ticket data with sensitive information omitted.

#### Features:
- Joins ticket data with a subquery (`lw12_referrals`) to count referrals based on the `referred_by` field.
- **Computed Columns:**
  - **referrals:** Number of referrals (defaults to 0 if none).
  - **platinum:** Boolean indicating if both Twitter and LinkedIn shares are recorded.
  - **secret:** Boolean indicating if a ticket has a non-null `game_won_at` (suggesting a win).

---

### meetups

- **Purpose:** Manages meetup events associated with launch weeks.

#### Columns:
- **id**: uuid
  - Primary Key, generated via `uuid_generate_v4()`.
- **created_at**: timestamp with time zone
  - Timestamp when the record is created (defaults to the current time).
- **launch_week**: text
  - Foreign key linking to `launch_weeks(id)`.
- **title**: text (nullable)
- **country**: text (nullable)
- **start_at**: timestamp with time zone (nullable)
- **link**: text (nullable)
- **display_info**: text (nullable)
- **is_live**: boolean
  - Indicates if the meetup is currently live (defaults to false).
- **is_published**: boolean
  - Indicates if the meetup is publicly published (defaults to false).

#### Security & Policies:
- **Row Level Security (RLS):** Enabled.
- Added to the `supabase_realtime` publication for real-time updates.
- A policy ("Allow anybody to select all meetups") permits public read access.

---

## Summary

This production schema supports both internal project management (via the remote schema tables) and customer-facing functionality (through our ticketing and event modules). The design emphasizes security with row-level security, detailed constraints, and real-time update capabilities to ensure robust, secure, and performance-optimized data handling.

*Note: Detailed grant and index configurations are managed directly within the migration files to support fine-grained access control.* 